---
// Fetch GitHub contribution data
const username = "eschmechel";
const currentYear = new Date().getFullYear();
const lastYear = new Date();
lastYear.setFullYear(lastYear.getFullYear() - 1);

// Format dates for display
const dateRange = `${lastYear.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })} - ${new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;

// Fetch contribution count from GitHub GraphQL API
let contributionCount = "Loading...";

try {
    const response = await fetch("https://api.github.com/graphql", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${import.meta.env.GITHUB_TOKEN}`, // Add token to .env
        },
        body: JSON.stringify({
            query: `
                query {
                    user(login: "${username}") {
                        contributionsCollection {
                            contributionCalendar {
                                totalContributions
                            }
                        }
                    }
                }
            `
        })
    });
    
    const data = await response.json();
    contributionCount = data.data.user.contributionsCollection.contributionCalendar.totalContributions.toString();
} catch (error) {
    console.error("Failed to fetch GitHub contributions:", error);
    contributionCount = "A very big number of"; // Fallback
}
---

<div class="flex flex-col gap-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 text-xs text-text-muted">
        {dateRange}
    </div>
    
    <a 
        target="_blank" 
        rel="noopener noreferrer" 
        href="https://github.com/eschmechel"
        class="block hover:opacity-90 transition-opacity"
    >
        <img 
            src={`https://ghchart.rshah.org/3B82F6/${username}`}
            width="720" 
            height="360" 
            loading="lazy"
            alt={`GitHub Chart for Elliott Schmechel - ${contributionCount} contributions`}
            class="w-full h-auto rounded-lg"
        />
    </a>
    
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div class="flex items-center gap-2 text-sm text-text-muted">
            <span class="text-text font-bold">{contributionCount}</span> contributions in the last year
        </div>
        
        <div class="flex items-center gap-2 text-xs text-text-muted">
            <span>Less</span>
            <div class="flex gap-1">
                <div class="w-3 h-3 bg-[#1e3a5f] rounded-sm"></div>
                <div class="w-3 h-3 bg-[#2563eb] rounded-sm"></div>
                <div class="w-3 h-3 bg-[#3b82f6] rounded-sm"></div>
                <div class="w-3 h-3 bg-[#60a5fa] rounded-sm"></div>
            </div>
            <span>More</span>
        </div>
    </div>
</div>
